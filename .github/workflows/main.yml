name: Home Assistant Configuration Validation

on:
  push:
      branches: [ main ]
          paths:
                - 'configuration/**'
                      - '.github/workflows/**'
                        pull_request:
                            branches: [ main ]
                                paths:
                                      - 'configuration/**'
                                        schedule:
                                            - cron: '0 2 * * *'  # Daily backup at 2 AM

                                            jobs:
                                              validate:
                                                  runs-on: ubuntu-latest
                                                      name: Validate Home Assistant Config

                                                              steps:
                                                                    - uses: actions/checkout@v3
                                                                            with:
                                                                                      fetch-depth: 0

                                                                                                  - name: Set up Python
                                                                                                          uses: actions/setup-python@v4
                                                                                                                  with:
                                                                                                                            python-version: '3.11'
                                                                                                                                  
                                                                                                                                        - name: Install dependencies
                                                                                                                                                run: |
                                                                                                                                                          python -m pip install --upgrade pip
                                                                                                                                                                    pip install homeassistant pyyaml
                                                                                                                                                                          
                                                                                                                                                                                - name: Validate YAML syntax
                                                                                                                                                                                        run: |
                                                                                                                                                                                                  python3 -c "
                                                                                                                                                                                                            import yaml
                                                                                                                                                                                                                      import glob
                                                                                                                                                                                                                                errors = []
                                                                                                                                                                                                                                          for file in glob.glob('configuration/**/*.yaml', recursive=True):
                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                          with open(file) as f:
                                                                                                                                                                                                                                                                                                yaml.safe_load(f)
                                                                                                                                                                                                                                                                                                                  print(f'✓ {file} - Valid')
                                                                                                                                                                                                                                                                                                                                except Exception as e:
                                                                                                                                                                                                                                                                                                                                                  errors.append(f'✗ {file} - {str(e)}')
                                                                                                                                                                                                                                                                                                                                                                    print(f'✗ {file} - {str(e)}')
                                                                                                                                                                                                                                                                                                                                                                              if errors:
                                                                                                                                                                                                                                                                                                                                                                                            exit(1)
                                                                                                                                                                                                                                                                                                                                                                                                      "
                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                  - name: Create backup
                                                                                                                                                                                                                                                                                                                                                                                                                          if: github.event_name == 'push'
                                                                                                                                                                                                                                                                                                                                                                                                                                  run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                            mkdir -p backups
                                                                                                                                                                                                                                                                                                                                                                                                                                                      zip -r backups/ha-config-$(date +%Y%m%d-%H%M%S).zip configuration/
                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo "Backup created successfully"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - name: Upload backup artifact
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if: github.event_name == 'push'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            uses: actions/upload-artifact@v3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              name: ha-config-backup
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        path: backups/
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  retention-days: 30
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - name: Notify on failure
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if: failure()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        echo "Configuration validation failed!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  exit 1
